# Databricks Connection Configuration
# Copy this file to .env.dev (development) or .env.prod (production)
# ⚠️ NEVER commit .env.* files to git (they're gitignored)

# ========================================
# DATABRICKS WORKSPACE AUTHENTICATION
# ========================================

# Option 1: Service Principal (RECOMMENDED for production)
# Uses OAuth M2M (machine-to-machine) authentication
# Ref: https://docs.databricks.com/aws/en/oltp/instances/authentication
DATABRICKS_SERVER_HOSTNAME=your-workspace.cloud.databricks.com
DATABRICKS_CLIENT_ID=<service_principal_application_id>
DATABRICKS_CLIENT_SECRET=<service_principal_secret>

# Option 2: Personal Access Token (Development only)
# ⚠️  Not recommended for production - tokens expire
# DATABRICKS_TOKEN=dapi...

# Databricks SQL Warehouse
DATABRICKS_WAREHOUSE_ID=your-warehouse-id

# Unity Catalog
DATABRICKS_CATALOG=lakehouse-sqlpilot
DATABRICKS_SCHEMA=lakehouse-sqlpilot-schema

# ========================================
# LAKEBASE (PostgreSQL for State Management)
# ========================================
# Lakebase uses the Database Credential API for automatic credential rotation
# The system will generate temporary OAuth tokens (~1 hour lifetime)
# Tokens auto-refresh in the background

LAKEBASE_HOST=instance-xxx.database.cloud.databricks.com
LAKEBASE_DATABASE=databricks_postgres
LAKEBASE_PORT=5432
LAKEBASE_USER=your-service-principal-application-id  # e.g., "535493cf-ae57-4661-bfda-629f5b98ead2"

# IMPORTANT: Instance name for Database Credential API
# This is the friendly NAME of your instance (not the UUID or hostname!)
# Example: if instance is named "lakehouse-sqlpilot", use that exact name
LAKEBASE_INSTANCE_NAME=your-instance-name

# LAKEBASE_PASSWORD is AUTO-GENERATED by the Database Credential API
# DO NOT set this manually - it will be generated automatically using:
#   - Service Principal authentication (client_id + client_secret)
#   - Database Credential API (w.database.generate_database_credential)
#   - Auto-refresh every ~50 minutes (tokens expire in 60 minutes)
# 
# For development/testing ONLY, you can run: python3 scripts/regenerate_lakebase_password.py
# But in production, the system handles this automatically!

# ========================================
# SECURITY SETTINGS
# ========================================

# OAuth Configuration (Recommended for Production)
SQLPILOT_OAUTH_ENABLED=true
SQLPILOT_OAUTH_CLIENT_ID=your-oauth-client-id
SQLPILOT_OAUTH_CLIENT_SECRET=your-oauth-client-secret
SQLPILOT_OAUTH_AUDIENCE=your-workspace-id

# API Security
SQLPILOT_REQUIRE_AUTH=true
SQLPILOT_SECRET_KEY=change-me-in-production-use-long-random-string
SQLPILOT_API_KEYS=

# Rate Limiting
SQLPILOT_RATE_LIMIT_ENABLED=true
SQLPILOT_RATE_LIMIT_REQUESTS=100
SQLPILOT_RATE_LIMIT_WINDOW=60

# Failed Auth Tracking
SQLPILOT_MAX_FAILED_AUTH=5
SQLPILOT_FAILED_AUTH_WINDOW=300

# CORS Origins (comma-separated)
SQLPILOT_ALLOWED_ORIGINS=http://localhost:5173,http://localhost:8080

# Request Size Limit (bytes)
SQLPILOT_MAX_REQUEST_SIZE=10485760

# Audit Logging
SQLPILOT_AUDIT_LOG_ENABLED=true

# Environment
SQLPILOT_ENV=development

# ========================================
# HOW TO SET UP SERVICE PRINCIPAL AUTH
# ========================================
# 1. Create a service principal in Databricks:
#    https://docs.databricks.com/en/dev-tools/service-principals.html
#
# 2. Grant it access to your Lakebase instance
#
# 3. Copy the Application (client) ID to DATABRICKS_CLIENT_ID
#
# 4. Generate a client secret and copy to DATABRICKS_CLIENT_SECRET
#
# 5. Run: python3 scripts/regenerate_lakebase_password.py
#    This generates the temporary OAuth token for LAKEBASE_PASSWORD
#
# 6. The system will auto-refresh tokens in the background
#
# ========================================
# HOW AUTOMATIC TOKEN REFRESH WORKS
# ========================================
# The system checks token expiration every 60 seconds and refreshes
# 5 minutes before expiry. This provides:
# - Zero downtime
# - Automatic failover
# - No manual intervention needed
#
# Refresh priority:
# 1. Database Credential API (service principal) ← RECOMMENDED
# 2. OAuth (if configured)
# 3. Static credentials (fallback)
#
# Reference: https://docs.databricks.com/aws/en/oltp/instances/authentication
