#!/bin/bash
# Environment Setup Script for Lakehouse SQLPilot
# This script helps you configure .env.dev for running all tests

set -e

echo "ðŸš€ Lakehouse SQLPilot - Environment Setup"
echo "=========================================="
echo ""

ENV_FILE=".env.dev"

# Check if .env.dev already exists
if [ -f "$ENV_FILE" ]; then
    echo "âš ï¸  .env.dev already exists"
    read -p "Do you want to update it? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "âŒ Setup cancelled"
        exit 1
    fi
    echo "ðŸ“ Backing up existing .env.dev to .env.dev.backup"
    cp "$ENV_FILE" "$ENV_FILE.backup"
fi

echo ""
echo "ðŸ“‹ Credential Setup Options:"
echo "1. Database Credential API (RECOMMENDED - auto-rotating)"
echo "2. Static Credentials (Quick test - manual rotation)"
echo "3. All Methods (Maximum resilience)"
echo ""
read -p "Choose option (1/2/3): " -n 1 -r OPTION
echo ""
echo ""

# Initialize env file with common settings
cat > "$ENV_FILE" << 'EOF'
# Lakehouse SQLPilot Environment Configuration
# Generated by setup script

# ========================================
# DATABRICKS WORKSPACE
# ========================================
EOF

if [[ $OPTION =~ ^[13]$ ]]; then
    echo "ðŸ” Database Credential API Setup"
    echo "================================"
    echo ""
    
    echo "ðŸ“ Step 1: Databricks Workspace Hostname"
    echo "   Example: your-workspace.cloud.databricks.com"
    echo "   (without https://)"
    read -p "   Enter hostname: " DB_HOST
    
    echo ""
    echo "ðŸ”‘ Step 2: Databricks Personal Access Token"
    echo "   Get from: Databricks â†’ Settings â†’ Developer â†’ Access Tokens"
    echo "   Starts with: dapi..."
    read -p "   Enter token: " DB_TOKEN
    
    cat >> "$ENV_FILE" << EOF
DATABRICKS_SERVER_HOSTNAME="$DB_HOST"
DATABRICKS_TOKEN="$DB_TOKEN"
EOF
    echo "âœ… Database Credential API configured"
    echo ""
fi

echo "ðŸ—„ï¸  Lakebase Connection Setup"
echo "============================="
echo ""

echo "ðŸ“ Lakebase Host"
echo "   Example: instance-xxx.database.cloud.databricks.com"
read -p "   Enter Lakebase host: " LAKEBASE_HOST

echo ""
echo "ðŸ“Š Lakebase Database Name"
read -p "   Enter database name [sqlpilot_state]: " LAKEBASE_DB
LAKEBASE_DB=${LAKEBASE_DB:-sqlpilot_state}

cat >> "$ENV_FILE" << EOF

# ========================================
# LAKEBASE (PostgreSQL for State)
# ========================================
LAKEBASE_HOST="$LAKEBASE_HOST"
LAKEBASE_DATABASE="$LAKEBASE_DB"
LAKEBASE_PORT="5432"
EOF

if [[ $OPTION =~ ^[23]$ ]]; then
    echo ""
    echo "ðŸ” Static Credentials Setup"
    echo "==========================="
    echo ""
    
    echo "ðŸ‘¤ Lakebase Username"
    read -p "   Enter username: " LAKEBASE_USER
    
    echo ""
    echo "ðŸ”‘ Lakebase Password"
    read -s -p "   Enter password: " LAKEBASE_PASSWORD
    echo ""
    
    cat >> "$ENV_FILE" << EOF

# Static Credentials (fallback)
LAKEBASE_USER="$LAKEBASE_USER"
LAKEBASE_PASSWORD="$LAKEBASE_PASSWORD"
EOF
    echo "âœ… Static credentials configured"
    echo ""
fi

# Optional: SQL Warehouse for UAT tests
echo ""
read -p "ðŸ“Š Configure SQL Warehouse for UAT tests? (y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ðŸ¢ SQL Warehouse ID"
    echo "   Get from: Databricks â†’ SQL Warehouses â†’ Your Warehouse â†’ Connection Details"
    read -p "   Enter warehouse ID: " WAREHOUSE_ID
    
    cat >> "$ENV_FILE" << EOF

# ========================================
# DATABRICKS SQL WAREHOUSE (for UAT)
# ========================================
DATABRICKS_WAREHOUSE_ID="$WAREHOUSE_ID"
EOF
    echo "âœ… SQL Warehouse configured"
fi

# Add standard settings
cat >> "$ENV_FILE" << 'EOF'

# ========================================
# UNITY CATALOG
# ========================================
DATABRICKS_CATALOG="lakehouse-sqlpilot"
DATABRICKS_SCHEMA="lakehouse-sqlpilot-schema"

# ========================================
# SECURITY SETTINGS
# ========================================
SQLPILOT_REQUIRE_AUTH=false
SQLPILOT_SECRET_KEY="dev-secret-key-change-in-production"
SQLPILOT_API_KEYS=""

# Rate Limiting
SQLPILOT_RATE_LIMIT_ENABLED=true
SQLPILOT_RATE_LIMIT_REQUESTS=100
SQLPILOT_RATE_LIMIT_WINDOW=60

# Failed Auth Tracking
SQLPILOT_MAX_FAILED_AUTH=5
SQLPILOT_FAILED_AUTH_WINDOW=300

# CORS Origins (comma-separated)
SQLPILOT_ALLOWED_ORIGINS="http://localhost:5173,http://localhost:8080"

# Request Size Limit (bytes)
SQLPILOT_MAX_REQUEST_SIZE=10485760

# Audit Logging
SQLPILOT_AUDIT_LOG_ENABLED=false

# Environment
SQLPILOT_ENV="development"
EOF

echo ""
echo "âœ… Configuration complete!"
echo ""
echo "ðŸ“„ Created: $ENV_FILE"
echo ""
echo "ðŸ§ª Testing configuration..."
echo ""

# Source the file
set -a
source "$ENV_FILE"
set +a

# Test configuration
python3 << 'PYTHON_TEST'
import os
import sys

print("ðŸ” Validating configuration...\n")

errors = []
warnings = []

# Check Lakebase
if not os.getenv("LAKEBASE_HOST"):
    errors.append("LAKEBASE_HOST is required")
else:
    print(f"âœ… Lakebase Host: {os.getenv('LAKEBASE_HOST')}")

# Check credential methods
db_api = os.getenv("DATABRICKS_SERVER_HOSTNAME") and os.getenv("DATABRICKS_TOKEN")
static = os.getenv("LAKEBASE_USER") and os.getenv("LAKEBASE_PASSWORD")

if db_api:
    print(f"âœ… Database Credential API: Configured")
    print(f"   Host: {os.getenv('DATABRICKS_SERVER_HOSTNAME')}")
else:
    warnings.append("Database Credential API not configured")

if static:
    print(f"âœ… Static Credentials: Configured")
    print(f"   User: {os.getenv('LAKEBASE_USER')}")
else:
    warnings.append("Static credentials not configured")

if not db_api and not static:
    errors.append("At least one credential method must be configured")

# Check SQL Warehouse
if os.getenv("DATABRICKS_WAREHOUSE_ID"):
    print(f"âœ… SQL Warehouse: {os.getenv('DATABRICKS_WAREHOUSE_ID')}")
else:
    warnings.append("SQL Warehouse not configured (UAT tests will be skipped)")

print()

if warnings:
    print("âš ï¸  Warnings:")
    for w in warnings:
        print(f"   - {w}")
    print()

if errors:
    print("âŒ Errors:")
    for e in errors:
        print(f"   - {e}")
    sys.exit(1)

print("âœ… Configuration is valid!\n")

# Try to initialize smart credential manager
try:
    from infrastructure.smart_credentials import get_smart_credential_manager
    manager = get_smart_credential_manager()
    methods = manager.get_available_methods()
    print(f"ðŸ“‹ Available credential methods: {', '.join(methods)}")
    
    # Try to get credentials
    try:
        username, password = manager.get_credentials()
        method = manager.get_last_successful_method()
        print(f"âœ… Successfully obtained credentials via: {method}")
        print(f"   Username: {username[:20]}...")
    except Exception as e:
        print(f"âš ï¸  Could not obtain credentials: {e}")
        print("   This may be normal if Databricks/Lakebase is not accessible")
        
except Exception as e:
    print(f"âš ï¸  Note: {e}")

PYTHON_TEST

if [ $? -eq 0 ]; then
    echo ""
    echo "ðŸŽ‰ Setup Complete!"
    echo ""
    echo "ðŸ“‹ Next Steps:"
    echo "1. Load environment: source .env.dev"
    echo "2. Run tests:        pytest tests/ -v"
    echo "3. Run specific:     pytest tests/test_lakebase_backend.py -v"
    echo ""
    echo "ðŸ“š Documentation:"
    echo "   - Full guide:     docs/TESTING_BLOCKED_TESTS_GUIDE.md"
    echo "   - Quick start:    docs/QUICK_START_AUTO_REFRESH.md"
    echo ""
else
    echo ""
    echo "âŒ Setup failed. Please fix errors and try again."
    echo ""
    exit 1
fi


